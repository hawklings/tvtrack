var request = require('request');
var querystring = require('querystring');
var eztv = require('eztv');
var cheerio = require('cheerio');
var fs = require('fs');
var levenshtein = require('levenshtein');
var Handlebars = require('handlebars');
var he = require('he');


var getSimilarity = function(str1, str2) {
    var l = new levenshtein(str1, str2);
    return (1 - (l.distance / Math.max(str1.length, str2.length))) * 100;
};

function titleCase(str) {
    var splitStr = str.toLowerCase().split(' ');
    for (var i = 0; i < splitStr.length; i++) {
        splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);
    }
    return splitStr.join(' ');
}

var internet = {
    cookieJar: undefined,
    makeRequest: function(url, formdata, callback) {
        request.get({
                url: url,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.110 Safari/537.36',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                jar: internet.cookieJar,
                body: querystring.stringify(formdata)
            },
            function(error, response, data) {
                if (error)
                    console.log(error);
                callback(data);
            });
    },
};

var pages = {
    goToPage: function(page) {
        $('.topbar>.selected').removeClass('selected');
        $('.pagelink[data-page="'+page+'"]').addClass('selected');
        $('.page').not('.' + page).animate({ opacity: 0 }, 200, function() {
            $('.page').not('.' + page).css({ top: '100%' });
        });
        $('.' + page).css({ top: 0 });
        $('.' + page).animate({ opacity: 1 }, 200, function() {

        });
    }
};

$(document).ready(function() {
    pages.goToPage('favourites');
    local.sync();
});

$(document).on('click', '.local-show-title', function(e) {
    $('.local>.episodes').html($(this).parent().children('.local-show-episodes').html());
});

$(document).on('click', '.availabletorrents-show-title', function(e) {
    var elements = $(this).parent().children('.availabletorrents-show-episodes').children("div").length;
    $(this).parent().children('.availabletorrents-show-episodes').stop();
    elements = Math.max(elements, 4);
    elements = Math.min(elements, 10);
    $(this).parent().children('.availabletorrents-show-episodes').slideToggle(50 * elements);
});

$(document).on('click', '.pagelink', function(e) {
    var page = $(this).attr('data-page');
    pages.goToPage(page);
    if (page === "local" || page === "availabletorrents") {
        local.sync();
    }
});

var getEpisodeDetailsFromName = function(name) {
    var showregex = /[Ss]{1}[0-9]{2}[Ee]{1}[0-9]{2}/ig;
    var match = showregex.exec(name);
    var obj = {
        season: 0,
        episode: 0
    };
    if (match !== null) {
        obj.season = parseInt(match[0].substr(1, 2));
        obj.episode = parseInt(match[0].substr(4, 2));
    }
    return obj;
};

$(document).on('click', '.torrents-show-episode>a', function() {
    local.sync();
});